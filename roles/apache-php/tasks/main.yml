---

- name: Block RedHat repositorios
  when: ansible_os_family == "RedHat"
  block:
    - name: Añadir repositorio Epel y Remi en distribucion RedHat
      ansible.builtin.yum:
        name: "{{ item }}"
        state: present
        disable_gpg_check: true
      loop:
        - https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm
        - https://rpms.remirepo.net/enterprise/remi-release-{{ ansible_distribution_major_version }}.rpm 

    - name: Habilitar modulo php
      ansible.builtin.command:
        cmd: "{{ item }}"
      loop:
        - yum module reset -y php
        - yum module enable -y php:remi-8.2
      changed_when: false

- name: Block Debian repositorios
  when: ansible_os_family == "Debian" and ansible_distribution == "Debian"
  block:
    - name: Instalar gnupg
      ansible.builtin.apt:
        name: gnupg
        state: present
        update_cache: true

    - name: Agregar clave GPG de repositorio Sury en distribucion Debian
      ansible.builtin.apt_key:
        url: https://packages.sury.org/php/apt.gpg
        state: present

    - name: Añadir repositorio Sury en distribucion Debian
      ansible.builtin.apt_repository:
        repo: deb https://packages.sury.org/php/ {{ ansible_distribution_release }} main
        state: present

- name: Instalar paquetes
  ansible.builtin.package:
    name: "{{ paquetes }}"
    state: present
    update_cache: true

- name: Iniciar servicio
  ansible.builtin.service:
    name: "{{ servicio }}"
    state: started
    enabled: true

- name: Rename folder
  ansible.builtin.lineinfile:
    path: /etc/httpd/conf/httpd.conf
    search_string: "    DirectoryIndex index.html"
    line: "    DirectoryIndex index.html index.php"
  notify: "Reiniciar apache/httpd"    

- name: Block habilitar regla firewalld para http si firewalld está instalado y habilitado
  when: ansible_os_family == "RedHat"
  block:
    - name: Comprobar servicio firewalld
      ansible.builtin.service:
        name: firewalld
        state: started
      changed_when: false

    - name: Habilitar regla http en firewalld
      ansible.posix.firewalld:
        service: http
        state: enabled
        permanent: true
        immediate: true
  rescue:
    - name: Mensaje aviso no firewalld
      ansible.builtin.debug:
        msg: "Error con Firewalld. No instalado, no habilitado o error en servicio"        

...